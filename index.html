<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Web Flores Timur</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <style>
        body { 
            padding-top: 56px; /* Adjust body padding to account for fixed navbar */
            font-family: 'Poppins', sans-serif; /* Apply Poppins to the whole body */
        }
        #map { height: calc(100vh - 56px); }
        .navbar-brand {
            font-weight: 700; /* Make the brand title bold */
        }
        /* New Legend Styles for Layer Control */
        .leaflet-control-layers-overlays label {
            display: block;
            margin-bottom: 10px;
        }
        .leaflet-legend-container {
            padding-left: 20px;
            font-size: 13px;
            margin-top: 5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }
        .legend-item i {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            opacity: 0.9;
            border: 1px solid #555;
        }
        .legend-line-container {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }
        .legend-line {
            display: inline-block;
            width: 20px;
            margin-right: 5px;
            border-bottom-style: solid;
            border-bottom-color: red;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Flores Timur</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">Tentang</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="map"></div>

    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="aboutModalLabel">Tentang Pengembang Web</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Nama: Auralia Laksa Aji</p>
            <p>NIM: 24/539992/SV/24735</p>
            <p>Kelas: PGWEB A</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Kecamatan Modal -->
    <div class="modal fade" id="kecamatanModal" tabindex="-1" aria-labelledby="kecamatanModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="kecamatanModalLabel">Detail Kecamatan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="kecamatanModalBody">
            <!-- Kecamatan details will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Toponimi Modal -->
    <div class="modal fade" id="toponimiModal" tabindex="-1" aria-labelledby="toponimiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="toponimiModalLabel">Toponimi</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="toponimiModalBody">
            <!-- Toponimi details will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        var map = L.map('map').setView([-8.3421453, 123.0469268], 10);

        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var esriSatelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        var baseMaps = {
            "OpenStreetMap": osm,
            "Esri Satellite": esriSatelit
        };

        // --- Layer Control ---
        var isCollapsed = window.innerWidth < 768;
        var layerControl = L.control.layers(baseMaps, {}, {
            position: 'topright',
            collapsed: isCollapsed
        }).addTo(map);

        // Responsive resize handler for layer control
        window.addEventListener('resize', function() {
            var newIsCollapsed = window.innerWidth < 768;
            if (newIsCollapsed) {
                layerControl.collapse();
            } else {
                layerControl.expand();
            }
        });

        map.createPane('batas_kecamatan_pane');
        map.getPane('batas_kecamatan_pane').style.zIndex = 410;
        map.createPane('sungai_pane');
        map.getPane('sungai_pane').style.zIndex = 420;
        map.createPane('jalan_pane');
        map.getPane('jalan_pane').style.zIndex = 430;

        // --- Styling Functions ---
        function getColor(d) {
            return d > 30000 ? '#800000' : // Maroon
                   d > 15000 ? '#A0522D' : // Sienna
                                '#D2B48C';  // Tan
        }

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.Penduduk),
                weight: 1.5,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        function getJalanWeight(namaUnsur) {
            switch (namaUnsur) {
                case 'Jalan Propinsi':
                    return 3;
                case 'Jalan Kabupaten':
                    return 2;
                case 'Jalan Lain':
                    return 1;
                default:
                    return 0.5;
            }
        }

        function styleJalan(feature) {
            return {
                color: 'red',
                weight: getJalanWeight(feature.properties.NAMA_UNSUR)
            };
        }

        // --- Legend HTML --- 
        const populationLegendHtml = `
            <div class="leaflet-legend-container">
                <strong>Jumlah Penduduk</strong>
                <div class="legend-item"><i style="background:#D2B48C"></i> <span>0 &ndash; 15000</span></div>
                <div class="legend-item"><i style="background:#A0522D"></i> <span>15000 &ndash; 30000</span></div>
                <div class="legend-item"><i style="background:#800000"></i> <span>30000+</span></div>
            </div>`;

        const roadLegendHtml = `
            <div class="leaflet-legend-container">
                <strong>Jenis Jalan</strong>
                <div class="legend-line-container"><span class="legend-line" style="border-bottom-width: 4px;"></span> Jalan Propinsi</div>
                <div class="legend-line-container"><span class="legend-line" style="border-bottom-width: 2.5px;"></span> Jalan Kabupaten</div>
                <div class="legend-line-container"><span class="legend-line" style="border-bottom-width: 1.5px;"></span> Jalan Lain</div>
            </div>`;


        // --- Fetch and Add Layers --- 
        const promises = [
            fetch('data/batas_kecamatan.geojson')
                .then(response => response.json())
                .then(data => {
                    var layer = L.geoJson(data, {
                        style: style,
                        pane: 'batas_kecamatan_pane',
                        onEachFeature: function (feature, layer) {
                            if (feature.properties) {
                                layer.bindTooltip(feature.properties.WADMKC, { sticky: true });
                                layer.on('click', function (e) {
                                    var props = e.target.feature.properties;
                                    var content = `<dl class="row"><dt class="col-sm-5">Kecamatan</dt><dd class="col-sm-7">${props.WADMKC}</dd><dt class="col-sm-5">Jumlah Penduduk</dt><dd class="col-sm-7">${props.Penduduk}</dd></dl>`;
                                    document.getElementById('kecamatanModalLabel').innerHTML = 'Detail Kecamatan';
                                    document.getElementById('kecamatanModalBody').innerHTML = content;
                                    new bootstrap.Modal(document.getElementById('kecamatanModal')).show();
                                });
                            }
                        }
                    }).addTo(map);
                    layerControl.addOverlay(layer, "Batas Kecamatan");
                }),

            fetch('data/jalan.geojson')
                .then(response => response.json())
                .then(data => {
                    var layer = L.geoJson(data, {
                        style: styleJalan,
                        pane: 'jalan_pane',
                        onEachFeature: function (feature, layer) {
                            if (feature.properties && feature.properties.NAMA_UNSUR) {
                                layer.bindTooltip(feature.properties.NAMA_UNSUR, { sticky: true });
                            }
                        }
                    }).addTo(map);
                    layerControl.addOverlay(layer, "Jalan");
                }),

            fetch('data/sungai.geojson')
                .then(response => response.json())
                .then(data => {
                    var layer = L.geoJson(data, {
                        style: { color: 'blue', weight: 1 },
                        pane: 'sungai_pane'
                    }).addTo(map);
                    layerControl.addOverlay(layer, "Sungai");
                }),

            fetch('data/toponimi.geojson')
                .then(response => response.json())
                .then(data => {
                    var layer = L.geoJson(data, {
                        onEachFeature: function (feature, layer) {
                            if (feature.properties && feature.properties.TOPONIMI) {
                                layer.on('click', function (e) {
                                    var feature = e.target.feature;
                                    var props = feature.properties;
                                    var coords = feature.geometry.coordinates;
                                    var lat = coords[1].toFixed(5);
                                    var lon = coords[0].toFixed(5);
                                    document.getElementById('toponimiModalLabel').innerHTML = props.TOPONIMI;
                                    var content = `<p>Koordinat: ${lat}, ${lon}</p>`;
                                    document.getElementById('toponimiModalBody').innerHTML = content;
                                    new bootstrap.Modal(document.getElementById('toponimiModal')).show();
                                });
                            }
                        }
                    }).addTo(map);
                    layerControl.addOverlay(layer, "Toponimi");
                })
        ];

        // --- Inject Legends after all layers are added ---
        Promise.all(promises).then(() => {
            const overlaysContainer = document.querySelector('.leaflet-control-layers-overlays');
            overlaysContainer.querySelectorAll('label').forEach(label => {
                const layerName = label.textContent.trim();
                if (layerName === 'Batas Kecamatan') {
                    const legendDiv = document.createElement('div');
                    legendDiv.innerHTML = populationLegendHtml;
                    label.appendChild(legendDiv);
                }
                if (layerName === 'Jalan') {
                    const legendDiv = document.createElement('div');
                    legendDiv.innerHTML = roadLegendHtml;
                    label.appendChild(legendDiv);
                }
            });
        });

        // --- Navbar color change on basemap change ---
        const navbar = document.querySelector('.navbar');
        map.on('baselayerchange', function (e) {
            if (e.name === 'Esri Satellite') {
                // Switch to light theme for satellite
                navbar.classList.remove('navbar-dark', 'bg-dark');
                navbar.setAttribute('data-bs-theme', 'light');
                navbar.style.backgroundColor = '#e3f2fd';
            } else {
                // Revert to dark theme for default
                navbar.removeAttribute('data-bs-theme');
                navbar.style.backgroundColor = '';
                navbar.classList.add('navbar-dark', 'bg-dark');
            }
        });

    </script>
</body>
</html>
